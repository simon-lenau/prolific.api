---
title: "The prolific.api package"
author: "Simon Lenau"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: yes
    toc_depth: 4
vignette: >
  %\VignetteIndexEntry{The prolific.api package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  \usepackage[utf8]{inputenc}
params:
  EVAL: !r identical(Sys.getenv("NOT_CRAN"), "true")
---

```{r, include = FALSE}
stopifnot(require(knitr))
options(width = 90)
knitr::opts_chunk$set(
  eval = FALSE,
  collapse = TRUE,
  comment = "#>",
  dev = "jpeg",
  dpi = 100,
  fig.asp = 0.8,
  fig.width = 5,
  out.width = "60%",
  fig.align = "center"
)
library(lenau)
library(prolific.api)
library(data.table)
library(reactable)
library(ggthemes)
```

<!-- Read the code chunks to be used -->
```{r, include=FALSE, cache=FALSE,eval=TRUE}
knitr::read_chunk(
  "prolificapi-package-chunks.R"
)
```

```{r, include=FALSE, cache=FALSE,eval=TRUE}
knitr::read_chunk(
  "list_prescreeners.R"
)
```

```{r start-date, include = FALSE,eval=TRUE}
```

```{r access-create-do, include = FALSE,eval=TRUE}
```





## Introduction

The **prolific.api** package provides functionalities for accessing the 
[prolific.co](https://www.prolific.co/) platform.
This allows to create and manage empirical crowd-sourcing studies from `R`.
A number of prescreening characteristics can be used to recruit specific groups of 
participants for a study.




***Note:***
An
[API token](https://docs.prolific.co/docs/api-docs/public/#section/Authentication) 
is required for accessing the API of 
[prolific.co](https://www.prolific.co/). 
For more details, see the section on *[obtaining an API token](#get-token)*.



## Core Functionalities

The main functionalities in the **prolific.api** package are provided in three
`ReferenceClasses`:

| Class                  | Functionality                                         |
| :--------------------- | :---------------------------------------------------- |
| `api_access`           | - Access the API<br>- Submit and retrieve information |
| `prolific_study`       | - Set up and modify studies                           |
| `prolific_prescreener` | - Define the group of eligible participants           |

*In general, all fields and methods of these classes are available in a `RefClass` as well as `S4` object style (see examples).*
The core functionalities are summarized below.

### Submitting and retrieving information: The `api_access` class

The `api_access` class is designed for interacting with 
[Prolific's API](https://docs.prolific.co/docs/api-docs/public/).
The central method to achieve this is `access`, which can be used
to exchange (retrieve and submit) information with the API.

#### Setting up an `api_access`



An `api_access` object can be created by 

```{r, eval = FALSE}
prolific_api_access <- api_access(api_token = "<api_token>")
```





The `api_token` is the only information that **needs to be specified** for the API access to work. 
All other settings when creating an `api_access` rarely require adjustment.

To check whether the token is valid, the `check_authorization` method is used:
```{r eval = TRUE}
check_authorization(prolific_api_access)
```


The section on 
*[obtaining an API token](#get-token)* 
describes how to obtain a valid token.

#### Using an `api_access` 

The actual API access is carried out using the `access` method of the `api_access` class.
The 
`access`
method wraps different methods for exchanging information with the API, depending on the purpose:

| Method   | Functionality                              |
| :------- | :----------------------------------------- |
| `get`    | Retrieving endpoint / data                 |
| `post`   | Create endpoint / send data                |
| `patch`  | Change endpoint using a delta (difference) |
| `put`    | Replace endpoint                           |
| `delete` | Delete endpoint                            |

This table lists the available methods, which are specified in the `method` argument of the `access` method.

For retrieving information from [prolific.co](https://www.prolific.co/) using the `get` method,
a simple example is

```{r, eval = FALSE}
access(prolific_api_access,
  method = "get",
  endpoint = "
  users/me"
)
```
to obtain information about the account you are accessing the API with.


A simple example for submitting information to the API using the `post` method is

```{r}
access(prolific_api_access,
  endpoint = "study-cost-calculator",
  method = "post",
  data = list(
    reward = 100,
    total_available_places = 5
  )
)
```

to calculate the cost  (including fees and taxes)  of a study where `5` participants are paid `1` Â£ each.

More realistic examples are provided in the sections below, while 
a list of further endpoints is provided in  
<!-- the [vignette on Prolific's API endpoints](prolificapi-endpoint.html)
as well as  -->
[Prolific's API documentation](https://docs.prolific.co/docs/api-docs/public).

### Set-up and change studies: The `prolific_study` class

The `prolific_study` class provides a lightweight interface for
creating, managing and modifying studies on [prolific.co](https://www.prolific.co/) using `R`.
There are a lot of options to be chosen from when setting up such a study, but let's start with a simple example.

#### Creating a `prolific_study`

A minimal specification for creating a `prolific_study` contains the following information:

```{r, study-create-simple, eval = TRUE}
```



The information that is presented to the potential participants 
contains the study's 

- **name**,
- **description**,
- **estimated completion time**,
- **reward** and
- **total available places**.

To them, the study will then will be presented as:

![Preview of the Prolific Study](Study_Preview.jpg){width=75%}  

<br/><br/>

People deciding to take part in a study can click on "Open study link in a new window", which redirects them
to the

- **external study url**

where the study is conducted.
Once they completed your study, you should provide them with a

- **completion code** 

and redirect them back to [prolific.co](https://www.prolific.co/).
Participant compensation is then based on the completion code by checking
whether a participant obtained the correct completion code
after completing the study.
^[Participant compensation does not happen automatically, so you still can check which participants are compensated, e.g. in case of erroneous completion codes.]



<!-- #### Validity-Check for a `prolific_study`

The arguments for constructing `new_study` above are the ones that need to be specified for a study to be 
created on [prolific.co](https://www.prolific.co/). To make sure that all necessary fields of a `prolific_study`
have been set, the `validity_check` method can be used.
In case a study has all required information, it simply returns `TRUE`:

``` {r eval = TRUE}
validity_check(new_study)
```

In cases where a study lacks some of the information, it returns a message that guides through the required steps:

``` {r eval = TRUE}
new_study_without_information <- prolific_study()
validity_check(new_study_without_information)
```

(note that the `estimated_completion_time`, `reward` and `total_available_places` 
are not mentioned in this message because they have default values of `1`). -->

##### Posting a `prolific_study` on the platform

After creating or changing a `prolific_study` in `R`,
the study can be submitted to  [prolific.co](https://www.prolific.co/) 
to represent it on the platform.


To submit the `new_study` created above to the Prolific platform,
we use 


``` {r, study-post-simple, eval = TRUE, show = TRUE}
```

The output shows that the study has been assigned an `id` (`"`r new_study$id`"` in this case).
This `id` is determined by [prolific.co](https://www.prolific.co/), 
and the unique identifier for the study on the platform.
You can now also find the study in the webinterface.


#### Getting a `prolific_study` from the platform

The study's `id` is also required if you want to obtain a previously created study from [prolific.co](https://www.prolific.co/).
For a study that is not yet represented in an R object, we first need to find out its id.

A list of *all* studies in the Prolific account can be obtained via

``` {r, study-list, eval = TRUE, show = TRUE}
```

``` {r, study-list-modify, include = FALSE,eval=TRUE}
```

which  in this case includes only the new study created above:

``` {r, study-list-print, eval = TRUE, show = TRUE}
```


To retrieve the study from the API, we use
the
study's endpoint, which is 
`"`r paste0("studies/",new_study$id)`"`:


``` {r, study-get-function, eval = TRUE, include = FALSE}
```

``` {r, eval = TRUE, include = FALSE}
knitr::read_chunk(
  lines = study_get_function(new_study)
)
```
``` {r, study-get, eval = TRUE, include = TRUE}
```

#### Updating Fields in a `prolific_study`  {#studies_fields_update}

The fields in a `prolific_study` can be changed using either `S4` and `RefClass` syntax.
For example, you can change the name of `new_study` using either one:

``` {r, study-rename, eval = TRUE, include = TRUE}
```

Both lines of code have the same effect: The `name` of `new_study` is now "`r new_study$name`".
Equivalent access works for all other fields in `prolific_study` objects, 
which are listed in the documentation `help(prolific_study)`.



##### Patching a `prolific_study` on the platform

To actually apply the changes made in the previous paragraph,
`prolific_api_access$access` with `method = "patch"` or `method = "put"` is used:

``` {r, study-patch-function, eval = TRUE, include = FALSE}
```

``` {r, eval = TRUE, include = FALSE}
knitr::read_chunk(
  lines = study_patch_function(new_study)
)
```

``` {r, study-patch, eval = TRUE, include = TRUE}
```

This applies a patch to the study on [prolific.co](https://www.prolific.co/).

###### Deleting a `prolific_study` on the platform
Ultimately, a study can be deleted using `access` with `method = "delete"` on the study's endpoint:x

``` {r, study-delete-function, eval = TRUE, include = FALSE}
```

``` {r, eval = TRUE, include = FALSE}
knitr::read_chunk(
  lines = study_delete_function(new_study)
)
```

``` {r, study-delete, eval = FALSE, include = TRUE,results=FALSE}
```

### Defining eligible participants: The `prolific_prescreener` class 


`prolific_prescreener` objects are used for characterizing the participants to be selected.
In that sense, they contain a description of the person's to be recruited in a `prolific_study`.
Various characteristics are available to define this target group. An exhaustive list is provided in the
[list of available prescreeners](#prescreener-list).

#### Setting up `prolific_prescreeners`

To make a simple example, participants who currently live in the United States can be selected using the `prolific_prescreener`

``` {r, prescreener-us, eval = TRUE, include = TRUE,results = FALSE}
```

You can combine multiple constraints for a single prescreener. 
To extend the above prescreener to also allow for participants from the UK, use


``` {r, prescreener-uk-us, eval = TRUE, include = TRUE,results = FALSE}
```

Some of the prescreeners allow to specify lower and upper boundaries for a numerical variable.
For example, participants with an age between `20` and `24` can be selected using the `prolific_prescreener`

``` {r, prescreener-age, eval = TRUE, include = TRUE,results = FALSE}
```
#### Using `prolific_prescreeners`

The prescreeners can be combined in a list and included as the `eligibility_requirements` of a `prolific_study`: 

```{r, study-create-prescreener, eval = TRUE}
```

This example creates a study that has the same information as `new_study` above, but is available only for
persons living in the UK or US who between `20` and `24` years of old.

As above, the study can be submitted to [prolific.co](https://www.prolific.co/) using

```{r, study-post-prescreener, eval = FALSE, results = FALSE}
```


**A full searchable list of all currently available prescreeners (as of `r Sys.Date()`)
is available in the
[list of available prescreeners](#prescreener-list).
It also includes example code snippets for each prescreener and available constraints.
**

#### List of available  `prolific_prescreeners` {#prescreener-list}

The following table contains **all** currently (as of `r Sys.Date()`) available prescreeners.
The `prescreener title` is to be used in the `title` field of a `prolific_prescreener` object.

***Click on the respective row to show all available constraints ***

***Click on the respective constraint to show R-code for setting up the prescreener***
<br></br>
<br></br>
<br></br>

```{r, reactable_list_of_prescreeners, eval = TRUE, results = TRUE, show = FALSE,echo=FALSE,warning=FALSE,message=FALSE,error=FALSE}
```


## Obtaining an API token {#get-token}

The **prolific.api** package requires 
an 
[API token](https://docs.prolific.co/docs/api-docs/public/#section/Authentication) 
for accessing the 
[API](https://docs.prolific.co/docs/api-docs/public)
of 
[prolific.co](https://www.prolific.co/).
To get such a token, you first need a researcher account on 
[prolific.co](https://www.prolific.co/).
When logging in to this account, you can obtain the 
<!-- *workspace-specific*  -->
token
<!-- by selecting the workspace you would like to work in, 
for which 
the tokens can be managed  -->
in the `Settings -> Go to API token page` menu.




``` {r, delete-all-studies, eval = TRUE, include = FALSE,results = FALSE}
```